{% extends "base.html" %}
{% load static humanize %}
{% block title %}{{ thread.title }} ‚Äî –ë–æ—á–∫–∞–ú–µ–¥—É{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="card mb-3 neon-hover">
      <div class="card-body d-flex justify-content-between align-items-start">
        <div>
          <h3 class="mb-1">{{ thread.title }}</h3>
          <div class="small text-muted">
            –ö–∞—Ç–µ–≥–æ—Ä—ñ—è: <a href="{{ thread.category.get_absolute_url }}">{{ thread.category.title }}</a>
            ‚Ä¢ –∞–≤—Ç–æ—Ä: <a href="{% url 'profile_view' thread.author.username %}">{{ thread.author.get_full_name|default:thread.author.username }}</a>
            ‚Ä¢ {{ thread.updated_at|naturaltime }}
          </div>
        </div>

        <div class="text-end">
          {% if user.is_authenticated %}
            {% if user == thread.author or user.is_staff %}
              <a href="{% url 'thread_edit' thread.pk %}"
                class="btn btn-sm btn-outline-primary me-2">
                –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Ç–µ–º—É
              </a>
            {% endif %}
          {% endif %}
          <span class="small text-muted">üí¨ {{ thread.posts.count }} ‚Ä¢ üëÄ {{ thread.views }}</span>
        </div>
      </div>
    </div>

    <!-- posts list -->
    <div id="posts">
      {% for p in posts %}
        {% include 'forum/_post.html' with p=p %}
      {% endfor %}
    </div>

    <!-- pagination for posts -->
    <nav aria-label="posts pagination">
      <ul class="pagination">
        {% if posts.has_previous %}
          <li class="page-item"><a href="?page={{ posts.previous_page_number }}" class="page-link">‚Üê</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">–°—Ç–æ—Ä—ñ–Ω–∫–∞ {{ posts.number }} –∑ {{ posts.paginator.num_pages }}</span></li>
        {% if posts.has_next %}
          <li class="page-item"><a href="?page={{ posts.next_page_number }}" class="page-link">‚Üí</a></li>
        {% endif %}
      </ul>
    </nav>

    <!-- post form (HTMX) -->
    {% if user.is_authenticated and not thread.closed %}
      <div class="card mt-3 fade-in neon-hover">
        <div class="card-body">
          <form id="post-form"
                hx-post="{% url 'post_create_htmx' thread.pk %}"
                hx-target="#posts"
                hx-swap="beforeend"
                hx-indicator="#post-indicator"
                method="post">
            {% csrf_token %}
            <input type="hidden" name="current_page" value="{{ posts.number }}">

            {# Quill editor root #}
            <label class="form-label">–¢–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</label>
            <div id="quill-editor" style="min-height:140px;"></div>

            {# –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π textarea, —è–∫–µ —Ä–µ–∞–ª—å–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä #}
            <textarea id="id_content" name="content" class="d-none" rows="6"></textarea>

            <div class="mt-2 d-flex justify-content-between align-items-center">
              <div id="post-indicator" style="display:none;">
                <div class="spinner-border spinner-border-sm"></div>
              </div>
              <div class="d-flex gap-2">
                <button class="btn btn-primary" type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
                <a class="btn btn-outline-secondary" href="{{ thread.get_absolute_url }}">–°–∫–∞—Å—É–≤–∞—Ç–∏</a>
              </div>
            </div>
          </form>
        </div>
      </div>
    {% elif thread.closed %}
      <div class="alert alert-warning mt-3">–¢–µ–º–∞ –∑–∞–∫—Ä–∏—Ç–∞ ‚Äî –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ.</div>
    {% else %}
      <div class="alert alert-info mt-3">–©–æ–± –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ ‚Äî <a href="{% url 'login' %}?next={{ request.path }}">—É–≤—ñ–π–¥–∏</a> –∞–±–æ <a href="{% url 'register' %}">–∑–∞—Ä–µ—î—Å—Ç—Ä—É–π—Å—è</a>.</div>
    {% endif %}
  </div>
</div>

<!-- HTMX ‚Äî –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –ü–ï–†–ï–î Quill —Ç–∞ –ø–µ—Ä–µ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—î—é —Ñ–æ—Ä–º–∏ -->
<script src="https://cdn.jsdelivr.net/npm/htmx.org@1.10.0"></script>

<!-- Quill CSS/JS (–≤—ñ–¥ CDN) -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async function () {
  // –ß–µ–∫–∞—î–º–æ, –ø–æ–∫–∏ htmx –ø—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è (–º–∞–∫—Å 2 —Å–µ–∫)
  await (function waitForHtmx(timeout = 2000) {
    return new Promise(resolve => {
      if (window.htmx) return resolve(true);
      const t0 = Date.now();
      const i = setInterval(() => {
        if (window.htmx) {
          clearInterval(i);
          return resolve(true);
        }
        if (Date.now() - t0 > timeout) {
          clearInterval(i);
          return resolve(false);
        }
      }, 50);
    });
  })();

  if (!window.htmx) {
    console.warn('htmx –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π: –ø–µ—Ä–µ–≤—ñ—Ä –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è —É base.html');
  }

  const quill = new Quill('#quill-editor', {
    theme: 'snow',
    placeholder: '–ù–∞–ø–∏—à–∏ —Å–≤–æ—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å...',
    modules: {
      toolbar: [
        ['bold','italic','underline'],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link']
      ]
    }
  });

  const form = document.getElementById('post-form');
  if (!form) return;

  form.addEventListener('submit', function (e) {
    const ta = document.getElementById('id_content');
    if (ta) ta.value = quill.root.innerHTML.trim();
    if (!ta.value || ta.value.replace(/(<([^>]+)>)/gi, '').trim().length === 0) {
      e.preventDefault();
      alert('–¢–µ–∫—Å—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ–º.');
      return false;
    }
  });

  // –ø—ñ—Å–ª—è —Ç–æ–≥–æ, —è–∫ HTMX –≤–∂–µ –≤—Å—Ç–∞–≤–∏–≤/–∑–∞–º—ñ–Ω–∏–≤ —á–∞—Å—Ç–∏–Ω—É DOM
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    const target = evt.detail && evt.detail.target;
    if (!target) return;
    // –Ω–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å —Ç—ñ–ª—å–∫–∏ –≤—Å—Ç–∞–≤–∫–∞ –≤ #posts
    if (target.id !== 'posts') return;

    // —Å–µ—Ä–≤–µ—Ä –º–∞—Ä–∫—É—î —Ç—ñ–ª—å–∫–∏ —â–æ–π–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –ø–æ—Å—Ç
    const newPost = target.querySelector('[data-new-post="true"]');
    if (!newPost) return;

    const postId = newPost.getAttribute('data-post-id');
    const lastPage = newPost.getAttribute('data-last-page');

    // –æ—á–∏—Å—Ç–∏—Ç–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä
    quill.root.innerHTML = '';

    // –ø–ª–∞–≤–Ω–æ –ø—Ä–æ—Å–∫—Ä–æ–ª–∏—Ç–∏ –¥–æ –ø–æ—Å—Ç–∞
    const el = document.getElementById('post-' + postId);
    if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // –æ–Ω–æ–≤–∏—Ç–∏ URL -> —â–æ–± –ø—ñ—Å–ª—è reload –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–∏—à–∏–≤—Å—è –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ –∑ –ø–æ—Å—Ç–æ–º
    if (lastPage) {
      const newUrl = window.location.pathname + '?page=' + lastPage + '#post-' + postId;
      history.replaceState({}, '', newUrl);
    }

    // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –º–∞—Ä–∫–µ—Ä–∏, —â–æ–± –Ω–µ –æ–±—Ä–æ–±–ª—è—Ç–∏ –≤–¥—Ä—É–≥–µ
    newPost.removeAttribute('data-new-post');
    newPost.removeAttribute('data-last-page');
    newPost.removeAttribute('data-post-id');
  });
});
</script>
{% endblock %}
